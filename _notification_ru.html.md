# Уведомления об оплате счетов (#notification)

###### Последнее обновление: 2017-05-31 | [Редактировать на GitHub](https://github.com/QIWI-API/bill-payments-rest-api-docs/blob/master/_notification_ru.html.md)

Уведомление представляет собой POST-запрос. Тело запроса содержит сериализованные данные счета в теле запроса (кодировка UTF-8), и параметр `command=bill`.

<h3 class="request method">Запрос → POST</h3>

~~~http
POST /qiwi-notify.php HTTP/1.1
Accept: application/json
Content-type: application/json
X-Api-Signature-SHA256: J4WNfNZd***V5mv2w=
Host: server.ru

{
  "bill": {
    "bill_id": "a475c739-0561-4a23-9d18-a96934a7d690",
    "prv_id":270304,
    "amount": 1,
    "currency": "RUB",
    "status":  { 
      "value" : "PAID",  
      "update_datetime" : "2017-12-27T16:01:00Z" },
    "user": {
      "phone": "79261234567", 
      "user_id" : "dsfc2recd123sdadx3dscfewcr234esdcf23", 
      "email" : "example@gmail.com"
    },
    "creation_datetime": "2017-08-17T09:56:02.241Z",
    "expiration_datetime": "2017-12-27T16:01:00Z",
    "version" : "3.0"
  }
}


HTTP/1.1 200 OK
Content-Type: application/json
{
 "error": 0
}
~~~

<ul class="nestedList url">
    <li><h3>URL</h3>
    </li>
</ul>

<aside class="notice">
Aдрес вашего сервера для уведомлений вы можете настроить на сайте <a href="https://kassa.qiwi.com/">kassa.qiwi.com</a>
</aside>

<ul class="nestedList header">
    <li><h3>HEADERS</h3>
        <ul>
             <li>X-Api-Signature-SHA256: ***</li>
             <li>Accept: application/json</li>
             <li>Content-type: application/json</li>
        </ul>
    </li>
</ul>

<ul class="nestedList params">
    <li><h3>Параметры</h3><span>В POST-запросе уведомления указываются параметры счета.</span>
    </li>
</ul>

Параметр|Описание|Тип
---------|--------|---
bill_id|Уникальный идентификатор счета в системе провайдера|String(30)
prv_id|[Идентификатор сайта](#auth_param) провайдера в API| Number
amount | Сумма счета. Способ округления зависит от валюты | Number(6.3)
currency | Идентификатор валюты счета (Alpha-3 ISO 4217 код) | String(3)
status | Объект статуса счета | Hashmap: <br> "value" - строковое значение статуса (String) <br> "update_datetime" - Дата обновления статуса (URL-закодированная строка ГГГГ-ММ-ДДTЧЧ:ММ:ССZ)
user | Объект пользователя, на которого был выставлен счет| Hashmap: <br> "phone" - Номер телефона, на который был выставлен счет (если был указан при выставлении счета) (Number) <br> "email" - E-mail пользователя (если был указан при выставлении счета). (String) <br> "user_id" - Идентификатор пользователя в системе провайдера (если был указан при выставлении счета). (String)
creation_datetime | Дата создания счета | URL-закодированная строка ГГГГ-ММ-ДДTЧЧ:ММ:ССZ
expiration_datetime | Дата истечения счета | URL-закодированная строка ГГГГ-ММ-ДДTЧЧ:ММ:ССZ
comment | Комментарий к счету | String(255)
extras | Дополнительные данные счета (если были указаны при выставлении счета).| Hashmap
version | Версия уведомлений | String

<h3 class="request method">Ответ → POST</h3>
Ответ на запрос должен быть в формате JSON.

### Заголовки

*  `Content-type: application/json`

~~~http
HTTP/1.1 200 OK
Content-Type: application/json

{
 "error": 0
}
~~~

<aside class="warning">
В ответе должен вернуться код результата обработки уведомления. Код результата должен находиться в параметре <i>error</i>.
Если в ответе код результата обработки уведомления отличается от 0 и/или код состояния HTTP отличается от 200 (OK), это интерпретируется как временная ошибка провайдера. Сервер повторяет запрос 36 раз с интервалом в 15 минут, далее 15 раз с интервалом в 60 минут. Таким образом, он делает еще 51 попытку за следующие 24 часа.
</aside>


<aside class="notice">
<ul>
<li>Рекомендуется возвращать коды результата в соответствии с таблицей <a href="#notify_codes">кодов завершения</a>.</li>
<li>Для получения уведомлений провайдер должен принимать HTTP-запросы из следующих подсетей исключительно по портам 80, 443:</li>
<ul>
<li> 91.232.230.0/23</li>
<li> 79.142.16.0/20</li>
</ul>
</ul>
</aside>


## Авторизация уведомлений (#notifications_auth)

Используется авторизация по цифровой подписи. Подпись уведомления отправляется в заголовке `X-Api-Signature-SHA256`. Для формирования подписи используется механизм проверки целостности HMAC с хэш-функцией SHA256.

HMAC sha256 от части полей, с разделителем |.+secret_key
X-Api-Signature: J4WNfNZd***V5mv2w=

* В качестве разделителей параметров используется символ `|`.
* В подписи участвуют следующие параметры (указаны в алфавитном порядке):
   * amount 
   * bill_id
   * currency
   * email (если есть)
   * phone (если есть)
   * prv_id
   * status.value
   * user_id (если есть)
* Параметры для подписи переводятся в байт-представление с UTF-8 и располагаются в алфавитном порядке.
* Ключ подписи равен secret_key из [параметров авторизации](#auth_param).

Алгоритм проверки подписи:

1. Получить строку, содержащую значения перечисленных параметров POST-запроса в алфавитном порядке перечисления параметров, разделенных символами `|`:

   `{parameter1}|{parameter2}|…`

   где `{parameter1}` – значение параметра уведомления. Все значения при проверке подписи должны трактоваться как строки.

2. Cтроку и ключ подписи преобразовать в байты с UTF-8.
3. Вычислить HMAC-хэш c шифрованием SHA256:

   `hash = HMAС(SHA256, secret_key_bytes, invoice_parameters_bytes)`
   Где:

   * `secret_key_bytes` – ключ функции (байт-представление секретного ключа);
   * `invoice_parameters_bytes` – байт-представление параметров POST-запроса для проверки подписи;
   * `hash` – результат хэш-функции.

4. HMAC-хэш преобразовать из строк в байты с использованием кодировки UTF-8 и base64-преобразовать.
5. Сравнить значение заголовка X-Api-Signature-SHA256 с результатом 4.


## Коды уведомлений  (#notify_codes)

Код завершения|Описание
--------------|--------
0|Успех
